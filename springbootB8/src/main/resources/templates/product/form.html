<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi"
      th:replace="~{layout/main :: content(~{::title}, ~{::body})}">
<head>
  <title>Product</title>
</head>
<body>
<section>
  <!-- tránh fallback GET -->
  <form id="frmProd" enctype="multipart/form-data" method="post" action="javascript:void(0)">
    <input type="hidden" id="productId" name="productId" th:value="${param.id}"/>
    <div class="grid">
      <label>Name <input type="text" name="productName" id="productName" required></label>
      <label>Qty <input type="number" name="quantity" id="quantity" value="1" required></label>
      <label>Price <input type="number" step="0.01" name="unitPrice" id="unitPrice" value="0" required></label>
      <label>Discount <input type="number" step="0.01" name="discount" id="discount" value="0" required></label>
      <label>Status <input type="number" name="status" id="status" value="1" required></label>
      <label>CategoryId <input type="number" name="categoryId" id="categoryId" required></label>
    </div>
    <div class="field">
      <label>Description</label>
      <input type="text" name="description" id="description" required>
    </div>
    <div class="field">
      <label>Image</label>
      <input type="file" name="imageFile" id="imageFile">
      <div id="preview" style="margin-top:6px"></div>
    </div>
    <div class="actions">
      <button class="btn" type="submit">Save</button>
      <a class="btn" th:href="@{/admin/products}">Back</a>
    </div>
  </form>
</section>

<script th:inline="javascript">
  // base context-path an toàn
  const base = /*[[@{/}]]*/ '';
  const urlJoin = (p)=> (base.endsWith('/')?base.slice(0,-1):base) + (p.startsWith('/')?p:'/'+p);

  const id  = /*[[${param.id}]]*/ null;

  function loadIfEdit(){
    if(!id) return;
    $.getJSON(urlJoin('/api/product/' + id), function(p){
      $('#productName').val(p.productName);
      $('#quantity').val(p.quantity);
      $('#unitPrice').val(p.unitPrice);
      $('#discount').val(p.discount);
      $('#status').val(p.status);
      $('#categoryId').val(p.category?.categoryId);
      $('#description').val(p.description);
      if (p.images) $('#preview').html(`<img src="${urlJoin('/uploads/'+p.images)}" width="64">`);
    });
  }

  $(document).on('submit','#frmProd', function(e){
    e.preventDefault();
    const fd = new FormData(this);
    const isEdit = !!$('#productId').val();
    const url = isEdit ? urlJoin('/api/product/updateProduct')
                       : urlJoin('/api/product/addProduct');
    const method = isEdit ? 'PUT' : 'POST';

    $.ajax({ url, type: method, data: fd, cache:false, contentType:false, processData:false })
      .done(()=> window.location.href = urlJoin('/admin/products'))
      .fail(xhr => alert('Lỗi lưu Product: ' + (xhr.responseText || xhr.status)));
  });

  $(loadIfEdit);
</script>
</body>
</html>
